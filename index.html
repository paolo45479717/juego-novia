<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Para Ti, Mi Preciosa ‚ù§Ô∏è</title>
    <style>
        /* --- (TU CSS ESPECTACULAR VA AQU√ç - SIN CAMBIOS) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            background-color: #8bac0f;
            background-image: linear-gradient(rgba(15, 56, 15, 0.1) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(15, 56, 15, 0.1) 1px, transparent 1px);
            background-size: 3px 3px;
            position: relative;
            transition: background 1s ease;
        }
        .night-mode {
            background-color: #1a0033;
            background-image: linear-gradient(rgba(100, 0, 150, 0.1) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(100, 0, 150, 0.1) 1px, transparent 1px);
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(248, 200, 220, 0.3);
            border-radius: 50%;
            pointer-events: none;
            animation: float 3s infinite ease-in-out;
        }
        .heart-particle {
            font-size: 1.2em;
            color: #ff69b4;
            position: absolute;
            pointer-events: none;
            animation: heartFloat 1.5s ease-out forwards;
            z-index: 200;
        }
        @keyframes heartFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            50% { opacity: 1; }
        }
        .pantalla-overlay {
            display: flex;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(30, 10, 30, 0.95) 100%);
            backdrop-filter: blur(10px);
            color: #f8c8dc;
            font-size: 2.2em;
            font-weight: bold;
            text-align: center;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.4;
            z-index: 100;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .pantalla-overlay span {
            animation: slideIn 0.6s ease-out;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        #playerNameInput {
            font-size: 0.6em;
            width: 80%;
            max-width: 300px;
            padding: 12px 18px;
            margin-top: 20px;
            border-radius: 12px;
            border: 3px solid #f8c8dc;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #eee;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(248, 200, 220, 0.3);
        }
        #playerNameInput:focus {
            outline: none;
            border-color: #fff;
            box-shadow: 0 6px 20px rgba(248, 200, 220, 0.6);
            transform: scale(1.05);
        }
        .btnMenu {
            font-size: 0.5em;
            padding: 15px 40px;
            margin-top: 25px;
            background: linear-gradient(135deg, #f8c8dc 0%, #ffd4e8 100%);
            color: #111;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(248, 200, 220, 0.4);
            position: relative;
            overflow: hidden;
        }
        .btnMenu::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btnMenu:hover::before {
            width: 300px;
            height: 300px;
        }
        h1 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: #f8c8dc;
            display: none;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            animation: titleBounce 0.8s ease-out;
        }
        @keyframes titleBounce {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        canvas {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 3px solid #f8c8dc;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(248, 200, 220, 0.6),
                          inset 0 0 20px rgba(0, 0, 0, 0.5);
            display: none;
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 320px;
            max-height: 320px;
            image-rendering: -moz-crisp-edges; /* Firefox */
            image-rendering: -webkit-crisp-edges; /* Chrome */
            image-rendering: pixelated; /* Est√°ndar */
            image-rendering: crisp-edges; /* IE */
            transition: all 0.3s ease;
        }
        canvas:hover {
            box-shadow: 0 0 40px rgba(248, 200, 220, 0.8),
                          inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            /* ... (resto de tu anim. shake) ... */
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .canvas-shake {
            animation: shake 0.5s;
        }
        #controles {
            display: none;
            grid-template-columns: repeat(3, 75px);
            grid-template-rows: repeat(2, 75px);
            gap: 12px;
            margin-top: 20px;
        }
        #controles button {
            font-size: 2.2em;
            border: none;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #f8c8dc;
            border-radius: 12px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            border: 2px solid #444;
        }
        #controles button:active {
            transform: scale(0.95);
        }
        #powerUpIndicator, #shieldIndicator, #speedIndicator, #magnetIndicator {
            position: absolute;
            top: 20px;
            background: linear-gradient(135deg, #f8c8dc 0%, #ffd4e8 100%);
            color: #111;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(248, 200, 220, 0.4);
            display: none;
            animation: powerUpPulse 0.5s infinite alternate;
            z-index: 50;
        }
        #powerUpIndicator { right: 20px; }
        #shieldIndicator { right: 20px; top: 70px; background: #00ffff; }
        #speedIndicator { right: 20px; top: 120px; background: #00ff00; }
        #magnetIndicator { right: 20px; top: 170px; background: #ff00ff; }

        @keyframes powerUpPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        #livesIndicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            display: none;
            z-index: 50;
        }
        #achievementsBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ffd700;
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            z-index: 60;
            display: none;
        }
        #achievementsPanel {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #f8c8dc;
            padding: 15px;
            border-radius: 12px;
            max-width: 250px;
            font-size: 0.8em;
            display: none;
            z-index: 70;
            border: 2px solid #f8c8dc;
        }
        .achievement {
            margin: 8px 0;
            padding: 8px;
            background: rgba(248, 200, 220, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
        }
        .achievement.unlocked {
            background: rgba(255, 215, 0, 0.3);
            color: #ffd700;
            font-weight: bold;
        }
        @media (min-width: 601px) {
            #controles { display: none !important; }
            h1 { font-size: 3em; }
            canvas { width: 520px; height: 520px; max-width: 520px; max-height: 520px; border-width: 4px; }
            .pantalla-overlay { font-size: 2.8em; }
            #powerUpIndicator, #livesIndicator, #shieldIndicator, #speedIndicator, #magnetIndicator {
                font-size: 1.2em; padding: 12px 25px;
            }
        }
        @keyframes comboPopup {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        .combo-text {
            position: absolute;
            color: #ffd700;
            font-weight: bold;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            pointer-events: none;
            animation: comboPopup 0.5s ease-out;
            z-index: 150;
        }
        #secretMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: #ff69b4;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 1.5em;
            display: none;
            z-index: 200;
            border: 3px solid #ffd700;
            animation: pulse 2s infinite;
        }
        /* Tus otros estilos (pulse, btnArriba, etc.) van aqu√≠ */
        #btnArriba { grid-column: 2 / 3; grid-row: 1 / 2; }
        #btnIzquierda { grid-column: 1 / 2; grid-row: 2 / 3; }
        #btnAbajo { grid-column: 2 / 3; grid-row: 2 / 3; }
        #btnDerecha { grid-column: 3 / 4; grid-row: 2 / 3; }
        #playerNameInput::placeholder { color: #aaa; }
    </style>
</head>
<body>
    <div id="welcomeMensaje" class="pantalla-overlay">
        <span>¬°Hola Mi Preciosa! ‚ù§Ô∏è</span>
        <span id="highScoreDisplay" class="scoreDisplay">Puntaje M√°s Alto: 0</span>
        <input type="text" id="playerNameInput" placeholder="Tu nombre aqu√≠" maxlength="20">
        <button id="btnJugar" class="btnMenu">¬°Jugar!</button>
    </div>

    <div id="gameOverMensaje" class="pantalla-overlay" style="display:none;">
        <span id="finalScoreDisplay">Tu puntaje: 0</span>
        <span>¬°Eres lo mejor de mi vida!</span>
        <span id="finalHighScoreDisplay"></span>
        <button id="btnReiniciar" class="btnMenu">Volver a Jugar</button>
    </div>

    <div id="victoryMessage" class="pantalla-overlay" style="display:none;">
        <span>¬°GANASTE EL JUEGO!</span>
        <span id="secretReveal" style="font-size:0.8em; margin-top:20px;">Cargando mensaje especial...</span>
        <button id="btnCredits" class="btnMenu">Cr√©ditos</button>
    </div>

    <div id="creditsScreen" class="pantalla-overlay" style="display:none; background: linear-gradient(135deg, #000428, #004e92);">
        <span>Desarrollado con amor por:</span>
        <span style="font-size:1.2em; color:#ffd700; margin:15px 0;">paolo45479717</span>
        <span>Para la persona m√°s especial del mundo</span>
        <span style="font-size:0.7em; margin-top:20px;">¬© 2025 - Hecho con el coraz√≥n</span>
        <button id="btnBack" class="btnMenu">Volver</button>
    </div>

    <div id="powerUpIndicator">POWER MODE!</div>
    <div id="shieldIndicator">üõ°Ô∏è ESCUDO!</div>
    <div id="speedIndicator">‚ö° VELOCIDAD!</div>
    <div id="magnetIndicator">üß≤ IM√ÅN!</div>
    <div id="livesIndicator">x 3</div>
    <button id="achievementsBtn">üèÜ</button>
    <div id="achievementsPanel"></div>

    <h1 id="gameTitle">¬°Nivel 1!</h1>
    <canvas id="gameCanvas" width="300" height="300"></canvas>
    <div id="controles">
        <button id="btnArriba">‚Üë</button>
        <button id="btnIzquierda">‚Üê</button>
        <button id="btnAbajo">‚Üì</button>
        <button id="btnDerecha">‚Üí</button>
    </div>

    <div id="secretMessage">
        <div>Mi amor...</div>
        <div style="margin:15px 0; font-size:1.2em;">T√∫ eres mi mayor tesoro</div>
        <div>Gracias por existir</div>
        <div style="margin-top:20px; color:#ffd700;">Te amo con todo mi coraz√≥n</div>
    </div>

    <audio id="bgMusic" src="musica.mp3" loop></audio>
    <audio id="eatSound" src="comer.mp3"></audio>
    <audio id="powerSound" src="poder.mp3" loop></audio> <audio id="deathSound" src="perder.mp3"></audio>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const CONFIG = {
            BOX_SIZE: 20,
            INITIAL_SPEED: 150,
            MIN_SPEED: 50,
            SPEED_DECREASE: 8,
            INITIAL_POWER_DURATION: 120,
            MIN_POWER_DURATION: 30,
            POWER_DECREASE: 8,
            POINTS_PER_PELLET: 10,
            POINTS_PER_POWER: 50,
            POINTS_PER_GHOST: 200,
            POINTS_PER_LEVEL: 1000,
            GHOST_COLORS: ["#ffb8b8", "#b8fff8", "#f8d8b8", "#ffc8f8"],
            INITIAL_LIVES: 3,
            MAX_LEVEL: 10,
            INVULNERABILITY_TICKS: 60, // ~6 segundos
            POWER_UP_DURATION: 180 // ~27 segundos
        };

        // ==================== ELEMENTOS DOM ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const box = CONFIG.BOX_SIZE;
        const canvasSize = canvas.width / box;

        const welcomeScreen = document.getElementById('welcomeMensaje');
        const gameOverScreen = document.getElementById('gameOverMensaje');
        const victoryScreen = document.getElementById('victoryMessage');
        const creditsScreen = document.getElementById('creditsScreen');
        const secretMessage = document.getElementById('secretMessage');

        const btnJugar = document.getElementById('btnJugar');
        const btnReiniciar = document.getElementById('btnReiniciar');
        const btnCredits = document.getElementById('btnCredits');
        const btnBack = document.getElementById('btnBack');

        const gameTitle = document.getElementById('gameTitle');
        const gameControls = document.getElementById('controles');
        const playerNameInput = document.getElementById('playerNameInput');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const finalScoreDisplay = document.getElementById('finalScoreDisplay');
        const finalHighScoreDisplay = document.getElementById('finalHighScoreDisplay');
        const secretReveal = document.getElementById('secretReveal');

        const powerUpIndicator = document.getElementById('powerUpIndicator');
        const shieldIndicator = document.getElementById('shieldIndicator');
        const speedIndicator = document.getElementById('speedIndicator');
        const magnetIndicator = document.getElementById('magnetIndicator');
        const livesIndicator = document.getElementById('livesIndicator');
        const achievementsBtn = document.getElementById('achievementsBtn');
        const achievementsPanel = document.getElementById('achievementsPanel');

        const bgMusic = document.getElementById('bgMusic');
        const eatSound = document.getElementById('eatSound');
        const powerSound = document.getElementById('powerSound');
        const deathSound = document.getElementById('deathSound');

        // ==================== VARIABLES ====================
        let player, ghosts, pellets, powerPellets, specialPowers = [];
        let score = 0, lives = CONFIG.INITIAL_LIVES, combo = 0, level = 1;
        let gameSpeed = CONFIG.INITIAL_SPEED, powerUpDuration = CONFIG.INITIAL_POWER_DURATION;
        let isPoweredUp = false, powerUpTimer = 0;
        let hasShield = false, shieldTimer = 0;
        let hasSpeed = false, speedTimer = 0;
        let hasMagnet = false, magnetTimer = 0;
        let isInvulnerable = false, invulnerabilityTimer = 0;
        let d, game;
        let playerName = "Preciosa";
        let achievements = [
            { id: "first_blood", name: "Primer Coraz√≥n", desc: "Come tu primer fantasma", unlocked: false },
            { id: "combo_master", name: "Combo x5", desc: "Logra un combo de 5", unlocked: false },
            { id: "speed_demon", name: "Velocista", desc: "Usa velocidad 3 veces", unlocked: false },
            { id: "shield_wall", name: "Muro Inquebrantable", desc: "Usa escudo 3 veces", unlocked: false },
            { id: "level_5", name: "Nivel 5", desc: "Llega al nivel 5", unlocked: false },
            { id: "perfect_level", name: "Nivel Perfecto", desc: "Completa un nivel sin perder vida", unlocked: false },
            { id: "millionaire", name: "Puntaje Alto", desc: "Llega a 10,000 puntos", unlocked: false },
            { id: "ghost_hunter", name: "Cazador de Amores", desc: "Come 20 fantasmas", unlocked: false },
            { id: "true_love", name: "Amor Verdadero", desc: "Gana el juego", unlocked: false },
            { id: "heart_collector", name: "Coleccionista", desc: "Recoge 500 puntos", unlocked: false }
        ];
        let ghostsEaten = 0, perfectLevel = true, speedUses = 0, shieldUses = 0;

        // ==================== ¬°NUEVO AUDIO MANAGER! ====================
        const AudioManager = {
            play(sound, isLoop = false) {
                sound.currentTime = 0;
                sound.loop = isLoop;
                sound.play().catch(() => {}); // Ignora errores si el usuario no ha interactuado
            },
            stop(sound) {
                sound.pause();
                sound.currentTime = 0;
            },
            stopAll() {
                this.stop(bgMusic);
                this.stop(powerSound);
            }
        };

        // ==================== MODO NOCTURNO ====================
        function updateTheme() {
            const hour = new Date().getHours();
            document.body.classList.toggle('night-mode', hour >= 18 || hour < 6);
        }
        setInterval(updateTheme, 60000);
        updateTheme();

        // ==================== PART√çCULAS CORAZ√ìN ====================
        function createHeartParticles(x, y, count = 5) {
            const canvasRect = canvas.getBoundingClientRect();
            for (let i = 0; i < count; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart-particle';
                heart.textContent = '‚ù§Ô∏è'; // Usar emoji
                
                // Convertir coordenadas del canvas a coordenadas de la p√°gina
                const pageX = canvasRect.left + (x / CONFIG.BOX_SIZE) * (canvasRect.width / canvasSize);
                const pageY = canvasRect.top + (y / CONFIG.BOX_SIZE) * (canvasRect.height / canvasSize);

                heart.style.left = (pageX + Math.random() * 20 - 10) + 'px';
                heart.style.top = (pageY + Math.random() * 20 - 10) + 'px';
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 1500);
            }
        }

        // ==================== GHOST CLASS ====================
        class Ghost {
            constructor(x, y, color, spawnX, spawnY) {
                this.x = x; this.y = y; this.color = color;
                this.spawnX = spawnX; this.spawnY = spawnY;
                this.lastMove = null;
            }
            getDistance(x1, y1, x2, y2) {
                return Math.abs(x1 - x2) + Math.abs(y1 - y2);
            }
            moveTowards(targetX, targetY, flee = false) {
                const moves = [
                    { x: this.x + box, y: this.y, dir: 'RIGHT' },
                    { x: this.x - box, y: this.y, dir: 'LEFT' },
                    { x: this.x, y: this.y + box, dir: 'DOWN' },
                    { x: this.x, y: this.y - box, dir: 'UP' }
                ].filter(m => {
                    if (this.lastMove === 'RIGHT' && m.dir === 'LEFT') return false;
                    if (this.lastMove === 'LEFT' && m.dir === 'RIGHT') return false;
                    if (this.lastMove === 'UP' && m.dir === 'DOWN') return false;
                    if (this.lastMove === 'DOWN' && m.dir === 'UP') return false;
                    // ¬°Correcci√≥n! Permitir que los fantasmas usen el wrap
                    return true;
                });

                if (moves.length === 0) moves.push({x: this.x, y: this.y, dir: null}); // No moverse

                let best = moves[0];
                let bestDist = flee 
                    ? -this.getDistance(best.x, best.y, targetX, targetY)
                    : this.getDistance(best.x, best.y, targetX, targetY);

                for (let m of moves) {
                    const dist = flee ? -this.getDistance(m.x, m.y, targetX, targetY) : this.getDistance(m.x, m.y, targetX, targetY);
                    if ((flee && dist > bestDist) || (!flee && dist < bestDist)) {
                        bestDist = dist;
                        best = m;
                    }
                }
                if (Math.random() < 0.15 && moves.length > 1) best = moves[Math.floor(Math.random() * moves.length)];
                
                this.x = best.x; this.y = best.y; this.lastMove = best.dir;

                // Wrap around
                if (this.x < 0) this.x = (canvasSize - 1) * box;
                if (this.x >= canvasSize * box) this.x = 0;
                if (this.y < 0) this.y = (canvasSize - 1) * box;
                if (this.y >= canvasSize * box) this.y = 0;
            }
            respawn() {
                this.x = this.spawnX; this.y = this.spawnY; this.lastMove = null;
            }
        }

        // ==================== HIGH SCORE & ACHIEVEMENTS ====================
        const Storage = {
            save(key, value) {
                try { localStorage.setItem('amorJuego_' + key, JSON.stringify(value)); } catch(e) {}
            },
            load(key, def) {
                try {
                    const data = localStorage.getItem('amorJuego_' + key);
                    return data ? JSON.parse(data) : def;
                } catch(e) { return def; }
            }
        };

        function unlockAchievement(id) {
            const ach = achievements.find(a => a.id === id);
            if (ach && !ach.unlocked) {
                ach.unlocked = true;
                Storage.save('achievements', achievements);
                showComboText('üèÜ ' + ach.name, player.x, player.y);
            }
        }

        function loadAchievements() {
            achievements = Storage.load('achievements', achievements);
        }

        function showAchievements() {
            achievementsPanel.innerHTML = '<div style="margin-bottom:10px;font-weight:bold;">Logros</div>';
            achievements.forEach(ach => {
                const div = document.createElement('div');
                div.className = 'achievement' + (ach.unlocked ? ' unlocked' : '');
                div.innerHTML = `${ach.unlocked ? 'üèÜ' : 'üîí'} <strong>${ach.name}</strong><br><small>${ach.desc}</small>`;
                achievementsPanel.appendChild(div);
            });
            achievementsPanel.style.display = 'block';
        }

        // ==================== JUEGO ====================
        function iniciarJuego() {
            score = 0; lives = CONFIG.INITIAL_LIVES; level = 1; combo = 0;
            gameSpeed = CONFIG.INITIAL_SPEED; powerUpDuration = CONFIG.INITIAL_POWER_DURATION;
            ghostsEaten = 0; perfectLevel = true; speedUses = 0; shieldUses = 0;
            loadAchievements();
            updateLives();
            AudioManager.play(bgMusic, true); // ¬°CORREGIDO!
            setUpLevel();
        }

        function setUpLevel() {
            gameTitle.textContent = `¬°Nivel ${level}!`;
            gameTitle.style.display = 'block';
            canvas.style.display = 'block';
            livesIndicator.style.display = 'block';
            achievementsBtn.style.display = 'block';
            if (window.innerWidth <= 600) gameControls.style.display = 'grid';

            d = undefined; isPoweredUp = false; powerUpTimer = 0;
            hasShield = false; shieldTimer = 0; hasSpeed = false; speedTimer = 0;
            hasMagnet = false; magnetTimer = 0; isInvulnerable = false; invulnerabilityTimer = 0;

            powerUpIndicator.style.display = 'none';
            shieldIndicator.style.display = 'none';
            speedIndicator.style.display = 'none';
            magnetIndicator.style.display = 'none';

            player = { x: 9 * box, y: 10 * box };
            ghosts = [];
            const positions = [[1,1],[canvasSize-2,1],[1,canvasSize-2],[canvasSize-2,canvasSize-2]];
            // A√±ade m√°s fantasmas seg√∫n el nivel
            for (let i = 0; i < Math.min(Math.floor(level / 2) + 1, 4); i++) {
                const [gx, gy] = positions[i];
                ghosts.push(new Ghost(gx*box, gy*box, CONFIG.GHOST_COLORS[i], gx*box, gy*box));
            }

            pellets = []; powerPellets = []; specialPowers = [];
            for (let x = 0; x < canvasSize; x++) {
                for (let y = 0; y < canvasSize; y++) {
                    if (x === 9 && y === 10) continue;
                    if (ghosts.some(g => g.x === x*box && g.y === y*box)) continue;

                    const isCorner = (x === 0 && y === 0) || (x === canvasSize-1 && y === 0) ||
                                     (x === 0 && y === canvasSize-1) || (x === canvasSize-1 && y === canvasSize-1);

                    if (isCorner) {
                        powerPellets.push({ x: x*box, y: y*box, type: 'power' });
                    } else if (Math.random() < 0.05 && level > 2) {
                        const types = ['shield', 'speed', 'magnet'];
                        specialPowers.push({ x: x*box, y: y*box, type: types[Math.floor(Math.random()*3)] });
                    } else {
                        pellets.push({ x: x*box, y: y*box });
                    }
                }
            }

            if (game) clearInterval(game);
            game = setInterval(draw, gameSpeed);
        }

        function updateLives() {
            livesIndicator.textContent = '‚ù§Ô∏è '.repeat(lives);
        }

        function loseLife() {
            perfectLevel = false;
            lives--;
            updateLives();
            AudioManager.play(deathSound); // ¬°CORREGIDO!
            AudioManager.stopAll(); // ¬°CORREGIDO!
            canvas.classList.add('canvas-shake');
            setTimeout(() => canvas.classList.remove('canvas-shake'), 500);

            if (lives <= 0) {
                mostrarGameOver();
            } else {
                player = { x: 9*box, y: 10*box }; d = undefined;
                isInvulnerable = true; invulnerabilityTimer = CONFIG.INVULNERABILITY_TICKS;
                ghosts.forEach(g => g.respawn());
                setTimeout(() => AudioManager.play(bgMusic, true), 1000); // Reanuda m√∫sica
            }
        }

        function nextLevel() {
            if (perfectLevel && level > 1) unlockAchievement('perfect_level');
            if (level === 5) unlockAchievement('level_5');
            if (level >= CONFIG.MAX_LEVEL) {
                mostrarVictoria();
                return;
            }

            clearInterval(game);
            level++;
            score += CONFIG.POINTS_PER_LEVEL;
            gameSpeed = Math.max(CONFIG.MIN_SPEED, gameSpeed - CONFIG.SPEED_DECREASE);
            powerUpDuration = Math.max(CONFIG.MIN_POWER_DURATION, powerUpDuration - CONFIG.POWER_DECREASE);
            perfectLevel = true;

            showComboText(`¬°Nivel ${level}!`, player.x, player.y);
            setTimeout(setUpLevel, 1000);
        }

        function mostrarGameOver() {
            clearInterval(game);
            AudioManager.stopAll(); // ¬°CORREGIDO!
            const hs = Storage.load('highscore', { value: 0, name: 'Nadie' });
            finalScoreDisplay.textContent = `${playerName}, Nivel ${level} - ${score} pts`;
            if (score > hs.value) {
                Storage.save('highscore', { value: score, name: playerName });
                finalHighScoreDisplay.textContent = `¬°NUEVO R√âCORD!`;
            } else {
                finalHighScoreDisplay.textContent = `R√©cord: ${hs.name} - ${hs.value}`;
            }
            hideGameElements();
            gameOverScreen.style.display = 'flex';
        }

        function mostrarVictoria() {
            clearInterval(game);
            AudioManager.stopAll(); // ¬°CORREGIDO!
            unlockAchievement('true_love');
            Storage.save('highscore', { value: score, name: playerName });
            hideGameElements();
            victoryScreen.style.display = 'flex';
            setTimeout(() => {
                secretReveal.textContent = "¬°Has desbloqueado mi coraz√≥n!";
                secretMessage.style.display = 'block';
            }, 2000);
        }

        function hideGameElements() {
            gameTitle.style.display = 'none';
            canvas.style.display = 'none';
            gameControls.style.display = 'none';
            livesIndicator.style.display = 'none';
            achievementsBtn.style.display = 'none';
            achievementsPanel.style.display = 'none';
            [powerUpIndicator, shieldIndicator, speedIndicator, magnetIndicator].forEach(el => el.style.display = 'none');
        }

        function showComboText(text, x, y) {
            const el = document.createElement('div');
            el.className = 'combo-text';
            el.textContent = text;
            
            const canvasRect = canvas.getBoundingClientRect();
            const pageX = canvasRect.left + (x / CONFIG.BOX_SIZE) * (canvasRect.width / canvasSize);
            const pageY = canvasRect.top + (y / CONFIG.BOX_SIZE) * (canvasRect.height / canvasSize);

            el.style.left = pageX + 'px';
            el.style.top = pageY + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // ==================== DIBUJO ====================
        function draw() {
            ctx.fillStyle = document.body.classList.contains('night-mode') ? '#1a1a1a' : '#222';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Pellets
            ctx.fillStyle = '#f8c8dc';
            pellets.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x + box/2, p.y + box/2, box/6, 0, Math.PI*2);
                ctx.fill();
            });

            // Power Pellets
            ctx.fillStyle = '#ffd700';
            powerPellets.forEach(p => {
                const pulse = Math.sin(Date.now() * 0.01) * 0.3 + 1;
                ctx.beginPath();
                ctx.arc(p.x + box/2, p.y + box/2, (box/4)*pulse, 0, Math.PI*2);
                ctx.fill();
            });

            // Special Powers
            specialPowers.forEach(p => {
                ctx.font = `${box*0.8}px Arial`;
                let emoji = '‚ùì';
                if(p.type === 'shield') emoji = 'üõ°Ô∏è';
                if(p.type === 'speed') emoji = '‚ö°';
                if(p.type === 'magnet') emoji = 'üß≤';
                ctx.fillText(emoji, p.x + box/2, p.y + box/2);
            });

            // Movimiento jugador
            const speed = hasSpeed ? 2 : 1;
            for (let i = 0; i < speed; i++) {
                if (!d) break;
                let nextX = player.x;
                let nextY = player.y;

                if (d === "LEFT") nextX -= box;
                if (d === "UP") nextY -= box;
                if (d === "RIGHT") nextX += box;
                if (d === "DOWN") nextY += box;
                
                // Wrap around
                if (nextX < 0) nextX = (canvasSize-1)*box;
                if (nextX >= canvasSize*box) nextX = 0;
                if (nextY < 0) nextY = (canvasSize-1)*box;
                if (nextY >= canvasSize*box) nextY = 0;

                player.x = nextX;
                player.y = nextY;
            }

            // Im√°n
            if (hasMagnet) {
                pellets = pellets.filter(p => {
                    if (Math.abs(p.x - player.x) < box*3 && Math.abs(p.y - player.y) < box*3) {
                        score += CONFIG.POINTS_PER_PELLET;
                        AudioManager.play(eatSound);
                        createHeartParticles(p.x, p.y, 3);
                        return false;
                    }
                    return true;
                });
            }

            // Comer
            pellets = pellets.filter(p => {
                if (p.x === player.x && p.y === player.y) {
                    score += CONFIG.POINTS_PER_PELLET;
                    combo++;
                    AudioManager.play(eatSound);
                    createHeartParticles(p.x, p.y);
                    if (score >= 500) unlockAchievement('heart_collector');
                    if (score >= 10000) unlockAchievement('millionaire');
                    return false;
                }
                return true;
            });

            powerPellets = powerPellets.filter(p => {
                if (p.x === player.x && p.y === player.y) {
                    score += CONFIG.POINTS_PER_POWER;
                    isPoweredUp = true; powerUpTimer = powerUpDuration;
                    powerUpIndicator.style.display = 'block';
                    AudioManager.stop(bgMusic); // ¬°CORREGIDO!
                    AudioManager.play(powerSound, true); // ¬°CORREGIDO!
                    combo = 0; // Combo se resetea
                    createHeartParticles(p.x, p.y, 8);
                    return false;
                }
                return true;
            });

            specialPowers = specialPowers.filter(p => {
                if (p.x === player.x && p.y === player.y) {
                    if (p.type === 'shield') { hasShield = true; shieldTimer = CONFIG.POWER_UP_DURATION; shieldIndicator.style.display = 'block'; shieldUses++; if (shieldUses >= 3) unlockAchievement('shield_wall'); }
                    if (p.type === 'speed') { hasSpeed = true; speedTimer = CONFIG.POWER_UP_DURATION; speedIndicator.style.display = 'block'; speedUses++; if (speedUses >= 3) unlockAchievement('speed_demon'); }
                    if (p.type === 'magnet') { hasMagnet = true; magnetTimer = CONFIG.POWER_UP_DURATION; magnetIndicator.style.display = 'block'; }
                    AudioManager.play(powerSound); // Sonido corto, no el loop
                    createHeartParticles(p.x, p.y, 6);
                    return false;
                }
                return true;
            });

            // Timers
            if (isPoweredUp && --powerUpTimer <= 0) { isPoweredUp = false; powerUpIndicator.style.display = 'none'; AudioManager.stop(powerSound); AudioManager.play(bgMusic, true); }
            if (hasShield && --shieldTimer <= 0) { hasShield = false; shieldIndicator.style.display = 'none'; }
            if (hasSpeed && --speedTimer <= 0) { hasSpeed = false; speedIndicator.style.display = 'none'; }
            if (hasMagnet && --magnetTimer <= 0) { hasMagnet = false; magnetIndicator.style.display = 'none'; }
            if (isInvulnerable && --invulnerabilityTimer <= 0) isInvulnerable = false;

            // Fantasmas
            ghosts.forEach(ghost => {
                ghost.moveTowards(player.x, player.y, isPoweredUp);
            });

            // Colisi√≥n
            for (let ghost of ghosts) {
                if (player.x === ghost.x && player.y === ghost.y) {
                    if (isPoweredUp) {
                        score += CONFIG.POINTS_PER_GHOST * (combo + 1);
                        ghostsEaten++;
                        if (ghostsEaten === 1) unlockAchievement('first_blood');
                        if (ghostsEaten >= 20) unlockAchievement('ghost_hunter');
                        showComboText(`+${CONFIG.POINTS_PER_GHOST * (combo + 1)}`, ghost.x, ghost.y);
                        ghost.respawn();
                        combo++;
                        if (combo >= 5) unlockAchievement('combo_master');
                        createHeartParticles(ghost.x, ghost.y, 10);
                        AudioManager.play(eatSound);
                    } else if (!isInvulnerable && !hasShield) {
                        loseLife();
                    } else if (hasShield) {
                        hasShield = false; shieldTimer = 0; shieldIndicator.style.display = 'none';
                        ghost.respawn();
                        AudioManager.play(deathSound);
                    }
                }
            }
            if (!isPoweredUp) combo = 0; // Resetea combo si se acaba el poder

            // Dibujar jugador
            ctx.fillStyle = '#ffff00';
            if (isInvulnerable && Math.floor(Date.now()/100)%2===0) ctx.fillStyle = '#ff69b4';
            if (hasShield) ctx.fillStyle = '#00ffff';
            
            ctx.beginPath();
            let angle = 0;
            if (d === "RIGHT") angle = 0;
            if (d === "LEFT") angle = Math.PI;
            if (d === "UP") angle = -Math.PI / 2;
            if (d === "DOWN") angle = Math.PI / 2;
            
            const mouth = !d ? 0.05 : 0.2 + Math.abs(Math.sin(Date.now() * 0.02)) * 0.2;
            ctx.arc(player.x + box/2, player.y + box/2, box/2.2, angle + mouth, angle - mouth);
            ctx.lineTo(player.x + box/2, player.y + box/2);
            ctx.fill();


            // Dibujar fantasmas
            ghosts.forEach(ghost => {
                ctx.fillStyle = isPoweredUp ? '#aaa' : ghost.color;
                if (isPoweredUp) {
                    // Forma de coraz√≥n
                    ctx.font = `${box*0.8}px Arial`;
                    ctx.fillText('‚ù§Ô∏è', ghost.x + box/2, ghost.y + box/2);
                } else {
                    // Forma de fantasma
                    ctx.beginPath();
                    ctx.arc(ghost.x + box/2, ghost.y + box/2, box/2.2, Math.PI, 0);
                    ctx.lineTo(ghost.x + box, ghost.y + box);
                    ctx.lineTo(ghost.x + box*0.8, ghost.y + box*0.8);
                    ctx.lineTo(ghost.x + box*0.6, ghost.y + box);
                    ctx.lineTo(ghost.x + box*0.4, ghost.y + box*0.8);
                    ctx.lineTo(ghost.x + box*0.2, ghost.y + box);
                    ctx.lineTo(ghost.x, ghost.y + box);
                    ctx.fill();
                }
                
                // Ojos
                ctx.fillStyle = 'white';
                let eyeX1 = ghost.x + box/3.5, eyeX2 = ghost.x + 2*box/3.5;
                let eyeY = ghost.y + box/3;
                if(d === 'LEFT' && !isPoweredUp) { eyeX1 -= 2; eyeX2 -= 2; }
                if(d === 'RIGHT' && !isPoweredUp) { eyeX1 += 2; eyeX2 += 2; }
                if(d === 'UP' && !isPoweredUp) { eyeY -= 2; }
                if(d === 'DOWN' && !isPoweredUp) { eyeY += 2; }
                
                ctx.beginPath();
                ctx.arc(eyeX1, eyeY, box/8, 0, Math.PI*2);
                ctx.arc(eyeX2, eyeY, box/8, 0, Math.PI*2);
                ctx.fill();

                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(eyeX1, eyeY, box/16, 0, Math.PI*2);
                ctx.arc(eyeX2, eyeY, box/16, 0, Math.PI*2);
                ctx.fill();
            });

            // Victoria
            if (pellets.length === 0 && powerPellets.length === 0 && specialPowers.length === 0) {
                nextLevel();
            }
        }

        // ==================== CONTROLES ====================
        document.getElementById('btnArriba').onclick = () => { if (d !== "DOWN") d = "UP"; };
        document.getElementById('btnAbajo').onclick = () => { if (d !== "UP") d = "DOWN"; };
        document.getElementById('btnIzquierda').onclick = () => { if (d !== "RIGHT") d = "LEFT"; };
        document.getElementById('btnDerecha').onclick = () => { if (d !== "LEFT") d = "RIGHT"; };

        document.addEventListener('keydown', e => {
            const key = e.key.toLowerCase();
            if (["arrowup","w"].includes(key) && d !== "DOWN") d = "UP";
            if (["arrowdown","s"].includes(key) && d !== "UP") d = "DOWN";
            if (["arrowleft","a"].includes(key) && d !== "RIGHT") d = "LEFT";
            if (["arrowright","d"].includes(key) && d !== "LEFT") d = "RIGHT";
            if (["arrowup", "arrowdown", "arrowleft", "arrowright"].includes(e.key)) {
                e.preventDefault();
            }
        });

        // ==================== EVENTOS ====================
        btnJugar.onclick = () => {
            playerName = playerNameInput.value.trim() || "Preciosa";
            Storage.save('playername', playerName);
            welcomeScreen.style.display = 'none';
            iniciarJuego();
        };

        btnReiniciar.onclick = () => location.reload();

        btnCredits.onclick = () => {
            victoryScreen.style.display = 'none';
            creditsScreen.style.display = 'flex';
        };

        btnBack.onclick = () => {
            location.reload();
        };

        achievementsBtn.onclick = () => {
            if (achievementsPanel.style.display === 'block') {
                achievementsPanel.style.display = 'none';
            } else {
                loadAchievements(); // Carga los √∫ltimos logros
                showAchievements();
            }
        };

        // ==================== INICIO ====================
        function init() {
            const hs = Storage.load('highscore', { value: 0, name: 'Nadie' });
            highScoreDisplay.textContent = `Puntaje M√°s Alto: ${hs.name} - ${hs.value}`;
            playerNameInput.value = Storage.load('playername', '');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 3 + 's';
                p.style.animationDuration = (2 + Math.random() * 2) + 's';
                document.body.appendChild(p);
            }
        }
        init();
    </script>
</body>
</html>
